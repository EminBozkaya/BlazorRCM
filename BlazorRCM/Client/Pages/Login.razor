@page "/login"
@using BlazorRCM.Shared.DTOs.ViewDTOs
@using BlazorRCM.Shared.Extensions
@layout BlazorRCM.Client.Shared.EmptyLayout

@inject SweetAlertService Swal;

<MudCard Style="border-radius:20px">
    @*<MudCard>*@
    <MudCardMedia Image="MyImages/Login/LoginPanel.png" Height="250" Style="position:relative" />

    <MudForm Model="@userLoginRequest">
        <MudCardContent>
            <MudTextField @bind-Value="@userLoginRequest.UserName"
                          Label="Kullanıcı Adı" />

            <MudTextField @bind-Value="@userLoginRequest.Password"
                          Label="Şifre" />

        </MudCardContent>

    </MudForm>

    <MudCardActions>
        <MudButton Variant="Variant.Filled" Color="Color.Error" Size="Size.Large" OnClick="@loginProcess" Style="margin-left:90px; width:130px; height:50px; border-radius:15px">Giriş</MudButton>
        <MudButton Variant="Variant.Text"
                   EndIcon="@Icons.Filled.QuestionMark"
                   Color="Color.Error"
                   Style="text-transform:none; margin-left: 100px;">
            Şifremi Unuttum
        </MudButton>
    </MudCardActions>
</MudCard>

@*EndIcon="fa-light fa-comment-question"*@
@*<i class="fa-light fa-comment-question" style="color:red"></i>*@
@code {

    [Inject]
    HttpClient? Client { get; set; }

    //[Inject]
    //ModalManager ModalManager { get; set; }

    [Inject]
    NavigationManager? NavManeger { get; set; }

    [Inject]
    ILocalStorageService? localStorageService { get; set; }

    [Inject]
    AuthenticationStateProvider? AuthenticationStateProvider { get; set; }

    private UserLoginRequestDTO userLoginRequest = new UserLoginRequestDTO();

    //LSManager lsm = new LSManager();

    private async Task loginProcess()
    {

        var httpReqRes = await Client!.PostAsJsonAsync("api/ManageUser/Login", userLoginRequest);

        if (httpReqRes.IsSuccessStatusCode)
        {
            try
            {
                var res = (await httpReqRes.Content.ReadFromJsonAsync<ServiceResponse<UserLoginResponseDTO>>())!;

                if (res.Success)
                {
                    await localStorageService!.SetItemAsync("token", res.Value!.ApiToken);
                    await localStorageService.SetItemAsync("email", res.Value.User!.Email);
                    //LocalStorageExtension.EMail = res.Value.User!.Email!;
                    //string email = LocalStorageExtension.EMail;
                    await localStorageService.SetItemAsync("fullname", res.Value.User!.FullName);
                    await localStorageService!.SetItemAsync("themeModeSwitch", false);

                    (AuthenticationStateProvider as AuthStateProvider)!.NotifyUserLogin(res.Value.User.Email!);

                    Client!.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", res.Value.ApiToken);

                    NavManeger!.NavigateTo("/userlist");
                }

                else
                {
                    NavManeger!.NavigateTo("/");
                }
            }

            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        else if((int)httpReqRes.StatusCode==401)await Swal.FireAsync("Başarısız", "yetkiniz yok", "error");
        else
        {
            await Swal.FireAsync("Başarısız", "Böyle bir kullanıcı yok", "error");
            //NavManeger.NavigateTo("/");
        }

    }
    }









    @*@code {

    [Inject]
    HttpClient Client { get; set; }

    [Inject]
    ModalManager ModalManager { get; set; }

    [Inject]
    NavigationManager NavManeger { get; set; }

    [Inject]
    ILocalStorageService localStorageService { get; set; }

    [Inject]
    AuthenticationStateProvider AuthenticationStateProvider { get; set; }

    private UserLoginRequestDTO userLoginRequest = new UserLoginRequestDTO();


    private async Task loginProcess()
    {
    var httpReqRes = await Client.PostAsJsonAsync("api/User/Login", userLoginRequest);

    if (httpReqRes.IsSuccessStatusCode)
    {
    try
    {
    var res = await httpReqRes.Content.ReadFromJsonAsync<ServiceResponse<UserLoginResponseDTO>>();

    if (res.Success)
    {

    await localStorageService.SetItemAsync("token", res.Value.ApiToken);
    await localStorageService.SetItemAsync("email", res.Value.User.EMailAddress);
    await localStorageService.SetItemAsync("UserId", res.Value.User.Id.ToString());
    await localStorageService.SetItemAsync("UserFullName", res.Value.User.FullName);

    (AuthenticationStateProvider as AuthStateProvider).NotifyUserLogin(res.Value.User.EMailAddress);

    Client.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", res.Value.ApiToken);

    NavManeger.NavigateTo("/");
    }
    else
    {

    await ModalManager.ShowMessageAsync("Login Error", res.Message);

    }
    }
    catch (Exception ex)
    {
    await ModalManager.ShowMessageAsync("Login Error", ex.Message);
    }
    }

    }

    }*@